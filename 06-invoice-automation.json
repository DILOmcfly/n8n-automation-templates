{
  "name": "Smart Invoicing System",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "new-sale",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-inv-1",
      "name": "Webhook - New Sale",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 400]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            { "value1": "={{ $json.customer_email }}", "operation": "isNotEmpty" },
            { "value1": "={{ $json.items }}", "operation": "isNotEmpty" }
          ]
        }
      },
      "id": "if-inv-validate",
      "name": "Validate Sale Data",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [460, 400]
    },
    {
      "parameters": {
        "jsCode": "const sale = $input.first().json;\n\n// Generate invoice number\nconst now = new Date();\nconst invoiceNum = `INV-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}-${String(Date.now()).slice(-5)}`;\n\n// Parse items and calculate totals\nconst items = typeof sale.items === 'string' ? JSON.parse(sale.items) : sale.items;\nlet subtotal = 0;\nconst lineItems = items.map((item, i) => {\n  const amount = (item.quantity || 1) * (item.unit_price || 0);\n  subtotal += amount;\n  return {\n    index: i + 1,\n    description: item.description || item.name || 'Item',\n    quantity: item.quantity || 1,\n    unit_price: (item.unit_price || 0).toFixed(2),\n    amount: amount.toFixed(2)\n  };\n});\n\nconst taxRate = sale.tax_rate || 0;\nconst taxAmount = subtotal * (taxRate / 100);\nconst total = subtotal + taxAmount;\nconst dueDate = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);\n\nreturn [{\n  json: {\n    invoice_number: invoiceNum,\n    invoice_date: now.toISOString().split('T')[0],\n    due_date: dueDate.toISOString().split('T')[0],\n    customer_name: sale.customer_name || 'Valued Customer',\n    customer_email: sale.customer_email,\n    customer_address: sale.customer_address || '',\n    company_name: sale.company_name || '',\n    items: lineItems,\n    subtotal: subtotal.toFixed(2),\n    tax_rate: taxRate,\n    tax_amount: taxAmount.toFixed(2),\n    total: total.toFixed(2),\n    currency: sale.currency || 'USD',\n    payment_terms: sale.payment_terms || 'Net 30',\n    notes: sale.notes || '',\n    status: 'sent',\n    created_at: now.toISOString()\n  }\n}];"
      },
      "id": "code-inv-process",
      "name": "Process Invoice Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 400],
      "notes": "Generates invoice number, calculates totals, tax, due date"
    },
    {
      "parameters": {
        "jsCode": "const inv = $input.first().json;\n\nconst itemRows = inv.items.map(item => `\n  <tr>\n    <td style=\"padding:10px;border-bottom:1px solid #eee;\">${item.index}</td>\n    <td style=\"padding:10px;border-bottom:1px solid #eee;\">${item.description}</td>\n    <td style=\"padding:10px;border-bottom:1px solid #eee;text-align:center;\">${item.quantity}</td>\n    <td style=\"padding:10px;border-bottom:1px solid #eee;text-align:right;\">${inv.currency} ${item.unit_price}</td>\n    <td style=\"padding:10px;border-bottom:1px solid #eee;text-align:right;\">${inv.currency} ${item.amount}</td>\n  </tr>\n`).join('');\n\nconst html = `\n<!DOCTYPE html>\n<html>\n<head><meta charset=\"utf-8\"><title>Invoice ${inv.invoice_number}</title></head>\n<body style=\"font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:40px;color:#333;\">\n  <div style=\"display:flex;justify-content:space-between;align-items:start;margin-bottom:40px;\">\n    <div>\n      <h1 style=\"color:#2563eb;margin:0;font-size:28px;\">INVOICE</h1>\n      <p style=\"color:#666;margin:5px 0;\">${inv.invoice_number}</p>\n    </div>\n    <div style=\"text-align:right;\">\n      <h2 style=\"margin:0;color:#333;\">Your Company Name</h2>\n      <p style=\"color:#666;margin:5px 0;font-size:14px;\">your@email.com<br>123 Business St<br>City, State 12345</p>\n    </div>\n  </div>\n  \n  <div style=\"display:flex;justify-content:space-between;margin-bottom:30px;\">\n    <div>\n      <h3 style=\"color:#666;margin:0 0 5px;font-size:12px;text-transform:uppercase;\">Bill To</h3>\n      <p style=\"margin:0;\"><strong>${inv.customer_name}</strong></p>\n      <p style=\"margin:0;color:#666;\">${inv.company_name ? inv.company_name + '<br>' : ''}${inv.customer_email}${inv.customer_address ? '<br>' + inv.customer_address : ''}</p>\n    </div>\n    <div style=\"text-align:right;\">\n      <table style=\"font-size:14px;\">\n        <tr><td style=\"color:#666;padding-right:15px;\">Invoice Date:</td><td><strong>${inv.invoice_date}</strong></td></tr>\n        <tr><td style=\"color:#666;padding-right:15px;\">Due Date:</td><td><strong>${inv.due_date}</strong></td></tr>\n        <tr><td style=\"color:#666;padding-right:15px;\">Terms:</td><td><strong>${inv.payment_terms}</strong></td></tr>\n      </table>\n    </div>\n  </div>\n  \n  <table style=\"width:100%;border-collapse:collapse;margin-bottom:30px;\">\n    <thead>\n      <tr style=\"background:#f8fafc;\">\n        <th style=\"padding:12px 10px;text-align:left;border-bottom:2px solid #2563eb;width:40px;\">#</th>\n        <th style=\"padding:12px 10px;text-align:left;border-bottom:2px solid #2563eb;\">Description</th>\n        <th style=\"padding:12px 10px;text-align:center;border-bottom:2px solid #2563eb;width:80px;\">Qty</th>\n        <th style=\"padding:12px 10px;text-align:right;border-bottom:2px solid #2563eb;width:120px;\">Unit Price</th>\n        <th style=\"padding:12px 10px;text-align:right;border-bottom:2px solid #2563eb;width:120px;\">Amount</th>\n      </tr>\n    </thead>\n    <tbody>\n      ${itemRows}\n    </tbody>\n  </table>\n  \n  <div style=\"display:flex;justify-content:flex-end;\">\n    <table style=\"width:300px;\">\n      <tr><td style=\"padding:8px 0;color:#666;\">Subtotal:</td><td style=\"text-align:right;padding:8px 0;\">${inv.currency} ${inv.subtotal}</td></tr>\n      ${inv.tax_rate > 0 ? `<tr><td style=\"padding:8px 0;color:#666;\">Tax (${inv.tax_rate}%):</td><td style=\"text-align:right;padding:8px 0;\">${inv.currency} ${inv.tax_amount}</td></tr>` : ''}\n      <tr style=\"border-top:2px solid #2563eb;\"><td style=\"padding:12px 0;\"><strong>Total:</strong></td><td style=\"text-align:right;padding:12px 0;font-size:20px;\"><strong>${inv.currency} ${inv.total}</strong></td></tr>\n    </table>\n  </div>\n  \n  ${inv.notes ? `<div style=\"margin-top:40px;padding:20px;background:#f8fafc;border-radius:8px;\"><h3 style=\"margin:0 0 10px;color:#666;font-size:14px;\">Notes</h3><p style=\"margin:0;\">${inv.notes}</p></div>` : ''}\n  \n  <div style=\"margin-top:40px;text-align:center;color:#999;font-size:12px;\">\n    <p>Thank you for your business! Payment is due by ${inv.due_date}.</p>\n  </div>\n</body>\n</html>`;\n\nreturn [{ json: { ...inv, invoice_html: html } }];"
      },
      "id": "code-inv-html",
      "name": "Generate Invoice HTML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400],
      "notes": "Professional invoice HTML template â€” customize branding here"
    },
    {
      "parameters": {
        "operation": "toFile",
        "sourceProperty": "invoice_html",
        "fileName": "={{ $json.invoice_number }}.html",
        "options": {}
      },
      "id": "html-to-file",
      "name": "HTML to File",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [1120, 400],
      "notes": "Converts HTML string to downloadable file. For PDF, connect an HTML-to-PDF service or use n8n's HTML node."
    },
    {
      "parameters": {
        "sendTo": "={{ $json.customer_email }}",
        "subject": "=Invoice {{ $json.invoice_number }} â€” {{ $json.currency }} {{ $json.total }}",
        "emailType": "html",
        "message": "=<h2>Hi {{ $json.customer_name }},</h2><p>Please find your invoice <strong>{{ $json.invoice_number }}</strong> attached.</p><p><strong>Amount Due:</strong> {{ $json.currency }} {{ $json.total }}<br><strong>Due Date:</strong> {{ $json.due_date }}<br><strong>Payment Terms:</strong> {{ $json.payment_terms }}</p><p>If you have any questions about this invoice, please don't hesitate to reach out.</p><p>Thank you for your business!</p><p>Best regards,<br>Your Company Name</p>",
        "options": {
          "attachments": "data"
        }
      },
      "id": "email-inv-send",
      "name": "Email Invoice to Customer",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1340, 400],
      "notes": "Sends invoice with HTML attachment"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": { "__rl": true, "value": "YOUR_SHEET_ID", "mode": "id" },
        "sheetName": { "__rl": true, "value": "Invoices", "mode": "name" },
        "columns": {
          "mappingMode": "defineBelow",
          "values": [
            { "column": "Invoice Number", "value": "={{ $json.invoice_number }}" },
            { "column": "Date", "value": "={{ $json.invoice_date }}" },
            { "column": "Due Date", "value": "={{ $json.due_date }}" },
            { "column": "Customer", "value": "={{ $json.customer_name }}" },
            { "column": "Email", "value": "={{ $json.customer_email }}" },
            { "column": "Subtotal", "value": "={{ $json.subtotal }}" },
            { "column": "Tax", "value": "={{ $json.tax_amount }}" },
            { "column": "Total", "value": "={{ $json.total }}" },
            { "column": "Currency", "value": "={{ $json.currency }}" },
            { "column": "Status", "value": "sent" },
            { "column": "Payment Terms", "value": "={{ $json.payment_terms }}" },
            { "column": "Items Count", "value": "={{ $json.items.length }}" }
          ]
        }
      },
      "id": "sheets-inv-log",
      "name": "Google Sheets - Log Invoice",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [1560, 400]
    },
    {
      "parameters": {
        "channel": "#accounting",
        "text": "=ðŸ’° *New Invoice Sent*\n\nðŸ“„ *Invoice:* {{ $json.invoice_number }}\nðŸ‘¤ *Customer:* {{ $json.customer_name }} ({{ $json.customer_email }})\nðŸ’µ *Amount:* {{ $json.currency }} {{ $json.total }}\nðŸ“… *Due Date:* {{ $json.due_date }}\nðŸ“¦ *Items:* {{ $json.items.length }} line item(s)\n\nâœ… Invoice emailed to customer.",
        "otherOptions": {}
      },
      "id": "slack-inv-notify",
      "name": "Slack - Invoice Sent",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1780, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"status\": \"success\", \"invoice_number\": \"{{ $json.invoice_number }}\", \"total\": \"{{ $json.currency }} {{ $json.total }}\", \"sent_to\": \"{{ $json.customer_email }}\" }"
      },
      "id": "respond-inv-ok",
      "name": "Respond - Invoice Created",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2000, 400]
    },
    {
      "parameters": {
        "rule": {
          "interval": [{ "field": "cronExpression", "expression": "0 9 * * *" }]
        }
      },
      "id": "schedule-inv-overdue",
      "name": "Daily Overdue Check",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 700]
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": { "__rl": true, "value": "YOUR_SHEET_ID", "mode": "id" },
        "sheetName": { "__rl": true, "value": "Invoices", "mode": "name" },
        "options": {}
      },
      "id": "sheets-inv-read",
      "name": "Google Sheets - Read Invoices",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [460, 700]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst now = new Date();\nconst sevenDaysMs = 7 * 24 * 60 * 60 * 1000;\n\nconst overdue = items.filter(item => {\n  const status = (item.json.Status || '').toLowerCase();\n  if (status === 'paid' || status === 'cancelled') return false;\n  \n  const dueDate = new Date(item.json['Due Date'] || item.json.due_date);\n  return (now - dueDate) > sevenDaysMs;\n});\n\nif (overdue.length === 0) {\n  return [{ json: { no_overdue: true, checked_at: now.toISOString() } }];\n}\n\nconst totalOverdue = overdue.reduce((sum, inv) => sum + parseFloat(inv.json.Total || 0), 0);\n\nreturn [{\n  json: {\n    no_overdue: false,\n    overdue_count: overdue.length,\n    total_overdue_amount: totalOverdue.toFixed(2),\n    currency: overdue[0].json.Currency || 'USD',\n    invoices: overdue.map(inv => ({\n      number: inv.json['Invoice Number'],\n      customer: inv.json.Customer,\n      email: inv.json.Email,\n      total: inv.json.Total,\n      due_date: inv.json['Due Date'],\n      days_overdue: Math.floor((now - new Date(inv.json['Due Date'])) / (24*60*60*1000))\n    })),\n    checked_at: now.toISOString()\n  }\n}];"
      },
      "id": "code-inv-overdue",
      "name": "Check Overdue Invoices",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 700]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            { "value1": "={{ $json.no_overdue }}", "value2": false }
          ]
        }
      },
      "id": "if-inv-overdue",
      "name": "Any Overdue?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [900, 700]
    },
    {
      "parameters": {
        "channel": "#accounting",
        "text": "=â° *Overdue Invoice Alert*\n\n{{ $json.overdue_count }} invoice(s) overdue (> 7 days)\nðŸ’¸ *Total Outstanding:* {{ $json.currency }} {{ $json.total_overdue_amount }}\n\n{{ $json.invoices.map(inv => `â€¢ *${inv.number}* â€” ${inv.customer} (${inv.email})\\n  Amount: ${inv.total} | Due: ${inv.due_date} | *${inv.days_overdue} days overdue*`).join('\\n\\n') }}\n\n_Please follow up with these customers._",
        "otherOptions": {}
      },
      "id": "slack-inv-overdue",
      "name": "Slack - Overdue Alert",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1120, 700]
    },
    {
      "parameters": {
        "rule": {
          "interval": [{ "field": "cronExpression", "expression": "0 8 1 * *" }]
        }
      },
      "id": "schedule-inv-monthly",
      "name": "Monthly Summary Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 1000]
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": { "__rl": true, "value": "YOUR_SHEET_ID", "mode": "id" },
        "sheetName": { "__rl": true, "value": "Invoices", "mode": "name" },
        "options": {}
      },
      "id": "sheets-inv-monthly-read",
      "name": "Read All Invoices",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [460, 1000]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst now = new Date();\nconst lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\nconst lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);\nconst monthName = lastMonth.toLocaleString('en', { month: 'long', year: 'numeric' });\n\nconst monthlyInvoices = items.filter(item => {\n  const date = new Date(item.json.Date || item.json.invoice_date);\n  return date >= lastMonth && date <= lastMonthEnd;\n});\n\nconst totalRevenue = monthlyInvoices.reduce((sum, inv) => sum + parseFloat(inv.json.Total || 0), 0);\nconst totalTax = monthlyInvoices.reduce((sum, inv) => sum + parseFloat(inv.json.Tax || 0), 0);\nconst paidCount = monthlyInvoices.filter(inv => (inv.json.Status || '').toLowerCase() === 'paid').length;\nconst pendingCount = monthlyInvoices.filter(inv => (inv.json.Status || '').toLowerCase() !== 'paid' && (inv.json.Status || '').toLowerCase() !== 'cancelled').length;\nconst currency = monthlyInvoices[0]?.json.Currency || 'USD';\n\n// Top customers\nconst customerTotals = {};\nmonthlyInvoices.forEach(inv => {\n  const name = inv.json.Customer || 'Unknown';\n  customerTotals[name] = (customerTotals[name] || 0) + parseFloat(inv.json.Total || 0);\n});\nconst topCustomers = Object.entries(customerTotals).sort((a, b) => b[1] - a[1]).slice(0, 5);\n\nreturn [{\n  json: {\n    month: monthName,\n    total_invoices: monthlyInvoices.length,\n    total_revenue: totalRevenue.toFixed(2),\n    total_tax: totalTax.toFixed(2),\n    net_revenue: (totalRevenue - totalTax).toFixed(2),\n    paid_count: paidCount,\n    pending_count: pendingCount,\n    avg_invoice_value: monthlyInvoices.length > 0 ? (totalRevenue / monthlyInvoices.length).toFixed(2) : '0.00',\n    currency: currency,\n    top_customers: topCustomers.map(([name, total]) => `${name}: ${currency} ${total.toFixed(2)}`).join(', '),\n    generated_at: now.toISOString()\n  }\n}];"
      },
      "id": "code-inv-monthly",
      "name": "Generate Monthly Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 1000]
    },
    {
      "parameters": {
        "channel": "#accounting",
        "text": "=ðŸ“Š *Monthly Revenue Report â€” {{ $json.month }}*\n\nðŸ’° *Total Revenue:* {{ $json.currency }} {{ $json.total_revenue }}\nðŸ“„ *Invoices Issued:* {{ $json.total_invoices }}\nâœ… *Paid:* {{ $json.paid_count }} | â³ *Pending:* {{ $json.pending_count }}\nðŸ’µ *Avg Invoice Value:* {{ $json.currency }} {{ $json.avg_invoice_value }}\nðŸ›ï¸ *Tax Collected:* {{ $json.currency }} {{ $json.total_tax }}\nðŸ“ˆ *Net Revenue:* {{ $json.currency }} {{ $json.net_revenue }}\n\nðŸ† *Top Customers:* {{ $json.top_customers || 'None' }}\n\n_Auto-generated monthly summary_",
        "otherOptions": {}
      },
      "id": "slack-inv-monthly",
      "name": "Slack - Monthly Summary",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [900, 1000]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"status\": \"error\", \"message\": \"Missing required fields: customer_email and items\" }"
      },
      "id": "respond-inv-error",
      "name": "Respond - Validation Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [680, 560]
    },
    {
      "parameters": {
        "channel": "#accounting",
        "text": "=âš ï¸ *Invoicing Error*\nNode: {{ $json.node_name || 'Unknown' }}\nError: {{ $json.error_message || 'Check execution log' }}\nTime: {{ new Date().toISOString() }}",
        "otherOptions": {}
      },
      "id": "slack-inv-error",
      "name": "Slack - Error Alert",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1340, 560]
    }
  ],
  "connections": {
    "Webhook - New Sale": {
      "main": [[{ "node": "Validate Sale Data", "type": "main", "index": 0 }]]
    },
    "Validate Sale Data": {
      "main": [
        [{ "node": "Process Invoice Data", "type": "main", "index": 0 }],
        [{ "node": "Respond - Validation Error", "type": "main", "index": 0 }]
      ]
    },
    "Process Invoice Data": {
      "main": [[{ "node": "Generate Invoice HTML", "type": "main", "index": 0 }]]
    },
    "Generate Invoice HTML": {
      "main": [[{ "node": "HTML to File", "type": "main", "index": 0 }]]
    },
    "HTML to File": {
      "main": [[{ "node": "Email Invoice to Customer", "type": "main", "index": 0 }]]
    },
    "Email Invoice to Customer": {
      "main": [[{ "node": "Google Sheets - Log Invoice", "type": "main", "index": 0 }]]
    },
    "Google Sheets - Log Invoice": {
      "main": [[{ "node": "Slack - Invoice Sent", "type": "main", "index": 0 }]]
    },
    "Slack - Invoice Sent": {
      "main": [[{ "node": "Respond - Invoice Created", "type": "main", "index": 0 }]]
    },
    "Daily Overdue Check": {
      "main": [[{ "node": "Google Sheets - Read Invoices", "type": "main", "index": 0 }]]
    },
    "Google Sheets - Read Invoices": {
      "main": [[{ "node": "Check Overdue Invoices", "type": "main", "index": 0 }]]
    },
    "Check Overdue Invoices": {
      "main": [[{ "node": "Any Overdue?", "type": "main", "index": 0 }]]
    },
    "Any Overdue?": {
      "main": [
        [{ "node": "Slack - Overdue Alert", "type": "main", "index": 0 }],
        []
      ]
    },
    "Monthly Summary Trigger": {
      "main": [[{ "node": "Read All Invoices", "type": "main", "index": 0 }]]
    },
    "Read All Invoices": {
      "main": [[{ "node": "Generate Monthly Summary", "type": "main", "index": 0 }]]
    },
    "Generate Monthly Summary": {
      "main": [[{ "node": "Slack - Monthly Summary", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "errorWorkflow": ""
  },
  "meta": {
    "description": "Complete invoicing automation: generates professional invoices from webhook sales data, emails them to customers, logs to accounting spreadsheet, alerts on overdue payments (>7 days), and generates monthly revenue reports.",
    "author": "DiegoAutomates",
    "tags": ["invoicing", "accounting", "pdf", "automation", "finance"]
  },
  "pinData": {
    "Webhook - New Sale": [
      {
        "json": {
          "customer_name": "Acme Corp",
          "customer_email": "billing@acmecorp.com",
          "company_name": "Acme Corporation",
          "customer_address": "456 Enterprise Ave, Suite 200, Business City, CA 90210",
          "items": [
            { "description": "n8n Workflow Setup â€” Lead Capture", "quantity": 1, "unit_price": 350 },
            { "description": "Custom Integration â€” Shopify + CRM", "quantity": 1, "unit_price": 500 },
            { "description": "Monthly Maintenance (3 months)", "quantity": 3, "unit_price": 100 }
          ],
          "tax_rate": 8.5,
          "currency": "USD",
          "payment_terms": "Net 30",
          "notes": "Thank you for choosing DiegoAutomates!"
        }
      }
    ]
  }
}
